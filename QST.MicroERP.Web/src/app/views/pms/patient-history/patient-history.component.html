<div class="container-fluid page">
    <div class="d-flex page_box p-3 mt-2  header-sticky" position="sticky">
        <div fxLayout="row" fxLayoutAlign="space-between" fxFlex="100%">
            <div>{{selectedPatient.patientName}} History
            </div>
            <div fxFlex="7%">
                <button mat-icon-button fxLayoutAlign="end end" (click)="dialogRef.close()" style="color: white">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
        </div>
    </div>
    <div class="page_content shadow p-3 position-relative">
        <div style=" margin-top: 20px;">
            <button mat-fab extended style="background-color:#4e4c4c ;color: white;margin: 5px;"
                (click)="dialogRef.close()">
                <mat-icon>arrow_back</mat-icon>
                Back
            </button>
        </div>
        <div fxLayout="column">
            <p style="text-align: center;align-items: center;justify-content: center;font-size: 25px;">
                <strong>Patient Name:</strong> {{selectedPatient.patientName}}
            </p>
            <hr>
            <div fxLayout="row" fxLayoutAlign="space-between" fxFlex="100%">
                <p fxFlex="50%"><strong>Age:</strong> {{selectedPatient.age}}</p>
                <p fxFlex="50%" style="text-align:end;"><strong>Contact No:</strong> {{selectedPatient.contactNo}}</p>
            </div>
            <div fxLayout="row" fxLayoutAlign="space-between" fxFlex="100%">
                <p fxFlex="50%" *ngIf="selectedPatient.city"><strong>City:</strong> {{selectedPatient.city}}</p>
                <p fxFlex="50%" *ngIf="selectedPatient.area" style="text-align:end;"><strong>Area:</strong>
                    {{selectedPatient.area}}</p>
            </div>
            <hr>
            <form #userForm="ngForm">
            <div style="text-align:center;padding-top: 70px;">
                <mat-form-field>
                    <mat-label>From Date</mat-label>
                    <input required matInput [matDatepicker]="startDateDP" name="from" [(ngModel)]="selectedRx.from" readonly
                        [max]="curDate">
                    <mat-datepicker-toggle matSuffix [for]="startDateDP"></mat-datepicker-toggle>
                    <mat-datepicker #startDateDP></mat-datepicker>
                </mat-form-field>
                <mat-form-field style="margin-left:10px">
                    <mat-label>To Date</mat-label>
                    <input required matInput [matDatepicker]="endDateDP" [min]="selectedRx.from" name="to" readonly
                        [(ngModel)]="selectedRx.to">
                    <mat-datepicker-toggle matSuffix [for]="endDateDP"></mat-datepicker-toggle>
                    <mat-datepicker #endDateDP></mat-datepicker>
                </mat-form-field>
                <button [disabled]="userForm.invalid" type="submit"  mat-icon-button cTooltip="Get record  in Date Range" (click)="onBlur()">
                    <mat-icon>search</mat-icon>
                </button>
                <button mat-icon-button mat-sm-button color="primary" cTooltip="Refresh  List" (click)="ngOnInit()">
                    <mat-icon>autorenew</mat-icon>
                </button>
            </div>
            </form>
            <div fxLayout="row">
                  <p>Total Visit(s) : &nbsp;</p>
                <b>{{ Prescription.length>0?Prescription.length:0 }}</b>
              
            </div>
            <c-card style="padding: 10px; margin-top: 30px;" class="mat-elevation-z8" *ngIf="Prescription.length>0">
                <c-card-body
                    style="padding: 10px;background-image: linear-gradient(to bottom, rgb(2, 33, 58), rgb(7, 95, 122));margin: 5px;border-radius: 10px;">
                    <div class="example-table-container">
                        <section class="example-container mat-elevation-z8" tabindex="0" style="border-radius: 5px;">
                            <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="mat-elevation-z8">
                                <ng-container matColumnDef="expand" sticky="true">
                                    <th mat-header-cell *matHeaderCellDef aria-label="row actions">
                                        <div style="width: 50px;">&nbsp;</div>
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <div *ngIf="element.rxMedicines.length>0 || element.reports.length>0">
                                            <button mat-icon-button aria-label="expand row"
                                                (click)="(expandedElement = expandedElement === element ? null : element); $event.stopPropagation();highlight(element)">
                                                <mat-icon *ngIf="expandedElement !== element">keyboard_arrow_down
                                                </mat-icon>
                                                <mat-icon *ngIf="expandedElement === element">keyboard_arrow_up
                                                </mat-icon>
                                            </button>
                                        </div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="Id">
                                    <th mat-header-cell *matHeaderCellDef> Sr No </th>
                                    <td mat-cell *matCellDef="let element"> {{element.id}} </td>
                                </ng-container>
                                <ng-container matColumnDef="tokenNo">
                                    <th mat-header-cell *matHeaderCellDef>
                                        <div style="min-width: 100px;"> Token No </div>
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <div style="min-width: 100px;"> {{element.tokenNo}}</div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="patient">
                                    <th mat-header-cell class="mat-cell" *matHeaderCellDef>
                                        <div style="min-width: 90px;"> Patient </div>
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <div style="min-width: 90px;"> {{element.patient}}</div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="doctor">
                                    <th mat-header-cell class="mat-cell" *matHeaderCellDef>
                                        <div style="min-width: 150px;"> Doctor </div>
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <div style="min-width: 150px;"> {{element.doctor}}</div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="time">
                                    <th mat-header-cell class="mat-cell" *matHeaderCellDef>
                                        <div style="min-width: 150px;"> Time </div>
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <div style="min-width: 150px;"> {{element.time}}</div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="amount">
                                    <th mat-header-cell *matHeaderCellDef>
                                        <div style="min-width: 90px;">Amount</div>
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <div style="min-width: 90px;"> {{element.amount}}</div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="remarks">
                                    <th mat-header-cell *matHeaderCellDef>
                                        <div style="min-width: 150px;"> Remarks </div>
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <div style="min-width: 150px;">{{element.remarks}}</div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="date">
                                    <th mat-header-cell *matHeaderCellDef>
                                        <div style="min-width: 150px;"> Date </div>
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <div style="min-width: 150px;">{{element.date|date:"dd/MM/yyyy"}}</div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="ecg">
                                    <th mat-header-cell *matHeaderCellDef>
                                        <div style="min-width: 100px;">ECG</div>
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <div style="min-width: 150px;">{{element.ecg}}</div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="bp">
                                    <th mat-header-cell *matHeaderCellDef>
                                        <div style="min-width: 150px;"> BP</div>
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <div style="min-width: 150px;"> {{element.bp}}</div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="weight">
                                    <th mat-header-cell *matHeaderCellDef>
                                        <div style="min-width: 150px;">Weight</div>
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <div style="min-width: 150px;">{{element.weight}}</div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="temperature">
                                    <th mat-header-cell *matHeaderCellDef>
                                        <div style="min-width: 150px;"> Temperature</div>
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <div style="min-width: 150px;"> {{element.temperature}}</div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="isActive">
                                    <th mat-header-cell *matHeaderCellDef>
                                        <div style="min-width: 50px;font-size: 14px;">IsActive</div>
                                    </th>
                                    <td mat-cell *matCellDef="let element">
                                        <div style="min-width: 50px;">{{element.isActive?'Yes':'No'}}</div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="Action" stickyEnd="true">
                                    <th mat-header-cell *matHeaderCellDef
                                        style="min-width: 150px; text-align: center;margin-left: 0;margin-right: 0;">
                                        <div style="font-size: 14px;">Action</div>
                                    </th>
                                    <td mat-cell *matCellDef="let row"
                                        style="min-width: 150px;text-align: center;margin-left: 0;margin-right: 0;">
                                        <div>
                                            <!-- <mat-icon (click)="EditPrescription(row)" matTooltip="Edit"
                                                style="cursor: pointer;">edit</mat-icon> -->
                                            <mat-icon (click)="ViewRx(row.id)" mat-icon-button mat-sm-button
                                                style="color: rgb(86, 3, 3);" matTooltip="View">visibility</mat-icon>
                                        </div>
                                    </td>
                                </ng-container>
                                <ng-container *ngFor="let column of extraColumns">
                                    <ng-container matColumnDef="{{ column }}">
                                        <th mat-header-cell *matHeaderCellDef style="min-width: 200px;">
                                            {{ column | titlecase }}</th>
                                        <td mat-cell *matCellDef="let element" style="min-width: 200px;">
                                            {{ getCellValue(element, column) }}</td>
                                    </ng-container>
                                </ng-container>
                                <ng-container matColumnDef="expandedDetail">
                                    <td mat-cell *matCellDef="let element"
                                        [attr.colspan]="columnsToDisplayWithExpand.length">
                                        <div class="example-element-detail" *ngIf="element.rxMedicines.length>0"
                                            style="align-items: center; border-radius: 30px;"
                                            [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
                                            <div *ngIf="expandedElement">
                                                <section class="example-container mat-elevation-z8" tabindex="0"
                                                    style="margin: 70px;border-radius: 30px;width: 55%;">
                                                    <h3>Medicine Detail</h3>
                                                    <table #innerTables mat-table [dataSource]="element.rxMedicines"
                                                        class="mat-elevation-z8" style=" overflow: auto;">
                                                        <ng-container matColumnDef="medicine">
                                                            <th mat-header-cell *matHeaderCellDef>
                                                                <div style="min-width: 150px;">Medicine</div>
                                                            </th>
                                                            <td mat-cell *matCellDef="let element">
                                                                <div style="min-width: 150px;">{{element.medicine}}
                                                                </div>
                                                            </td>
                                                        </ng-container>
                                                        <ng-container matColumnDef="mr">
                                                            <th mat-header-cell *matHeaderCellDef>
                                                                <div style="min-width: 150px;"> Meal Relation</div>
                                                            </th>
                                                            <td mat-cell *matCellDef="let element">
                                                                <div style="min-width: 150px;"> {{element.mr}}</div>
                                                            </td>
                                                        </ng-container>
                                                        <ng-container matColumnDef="amQty">
                                                            <th mat-header-cell *matHeaderCellDef>
                                                                <div style="min-width: 120px;"> Morning Qty</div>
                                                            </th>
                                                            <td mat-cell *matCellDef="let element">
                                                                <div style="min-width: 120px;"> {{element.amQty}}</div>
                                                            </td>
                                                        </ng-container>
                                                        <ng-container matColumnDef="noonQty">
                                                            <th mat-header-cell *matHeaderCellDef>
                                                                <div style="min-width: 120px;"> Noon Qty</div>
                                                            </th>
                                                            <td mat-cell *matCellDef="let element">
                                                                <div style="min-width: 120px;">{{element.noonQty}}</div>
                                                            </td>
                                                        </ng-container>
                                                        <ng-container matColumnDef="eveQty">
                                                            <th mat-header-cell *matHeaderCellDef>
                                                                <div style="min-width: 120px;"> Evening Qty</div>
                                                            </th>
                                                            <td mat-cell *matCellDef="let element">
                                                                <div style="min-width: 120px;">{{element.eveQty}}</div>
                                                            </td>
                                                        </ng-container>
                                                        <ng-container matColumnDef="days">
                                                            <th mat-header-cell *matHeaderCellDef>
                                                                <div style="min-width: 120px;"> Days</div>
                                                            </th>
                                                            <td mat-cell *matCellDef="let element">
                                                                <div style="min-width: 120px;">{{element.days}}</div>
                                                            </td>
                                                        </ng-container>
                                                        <ng-container matColumnDef="remarks">
                                                            <th mat-header-cell *matHeaderCellDef>
                                                                <div style="min-width: 150px;"> Remarks</div>
                                                            </th>
                                                            <td mat-cell *matCellDef="let element">
                                                                <div style="min-width: 150px;">{{element.remarks}}</div>
                                                            </td>
                                                        </ng-container>
                                                        <tr mat-header-row *matHeaderRowDef="innerDisplayedColumns">
                                                        </tr>
                                                        <tr mat-row
                                                            *matRowDef="let row; columns: innerDisplayedColumns;">
                                                        </tr>
                                                    </table>
                                                </section>
                                            </div>
                                        </div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="reports">
                                    <td mat-cell *matCellDef="let element"
                                        [attr.colspan]="columnsToDisplayWithExpand.length">
                                        <div class="example-element-detail" *ngIf="element.reports.length>0"
                                            style="align-items: center; border-radius: 30px;"
                                            [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
                                            <div *ngIf="expandedElement">
                                                <section class="example-container mat-elevation-z8" tabindex="0"
                                                    style="margin-left: 70px;margin-top: 30px;
                                               text-align: center; margin-bottom: 30px; border-radius: 30px;width: 100%;">
                                                    <h3>Reports</h3>
                                                    <table #innerTables mat-table [dataSource]="element.reports"
                                                        class="mat-elevation-z8" style=" overflow: auto;">
                                                        <ng-container matColumnDef="date">
                                                            <th mat-header-cell *matHeaderCellDef
                                                                class="custom-sort-header"> Date</th>
                                                            <td mat-cell *matCellDef="let element">
                                                                {{element.date|date:"dd/MM/yyyy"}} </td>
                                                        </ng-container>
                                                        <ng-container matColumnDef="category">
                                                            <th mat-header-cell *matHeaderCellDef
                                                                class="custom-sort-header">Category </th>
                                                            <td mat-cell *matCellDef="let element"> {{element.category}}
                                                            </td>
                                                        </ng-container>
                                                        <ng-container matColumnDef="actions" stickyEnd
                                                            style="z-index: 0;">
                                                            <th mat-header-cell *matHeaderCellDef
                                                                style="width: 70px; text-align: center;">
                                                                <div>Actions</div>
                                                            </th>
                                                            <td mat-cell *matCellDef="let row"
                                                                style="width: 70px;text-align: center;">
                                                                <div>
                                                                    <a href="javascript:void(0);"
                                                                        cTooltip="View Report "
                                                                        (click)="openReportInNewPage(row.reportBase64Path)"
                                                                        class="popup-link">
                                                                        <mat-icon
                                                                            style="color: #043083;">visibility</mat-icon>
                                                                    </a>
                                                                    <a [href]="row.reportBase64Path" download>
                                                                        <mat-icon cTooltip="Download Report"
                                                                            style="color: #57788c;">download</mat-icon>
                                                                    </a>
                                                                </div>
                                                            </td>
                                                        </ng-container>
                                                        <tr mat-header-row *matHeaderRowDef="rptDisplayedCol"></tr>
                                                        <tr mat-row *matRowDef="let row; columns: rptDisplayedCol;">
                                                        </tr>
                                                    </table>
                                                </section>
                                            </div>
                                        </div>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="header-row-first-group">
                                    <th mat-header-cell *matHeaderCellDef [attr.colspan]="8">
                                        <div style=" width: 100%;">.</div>
                                    </th>
                                </ng-container>
                                <ng-container matColumnDef="header-row-second-group" stickyEnd="true">
                                    <th mat-header-cell *matHeaderCellDef style="text-align: center;"
                                        [attr.colspan]="3">
                                        <div style=" width: 100%;">Actions</div>
                                    </th>
                                </ng-container>
                                <!-- <tr mat-header-row style="height:10px ; "
                                *matHeaderRowDef="['header-row-first-group', 'header-row-second-group']"></tr> -->
                                <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
                                <tr mat-row *matRowDef="let element; columns: columnsToDisplayWithExpand;"
                                    class="example-element-row"
                                    [class.example-expanded-row]="expandedElement === element"
                                    [ngClass]="{'highlight': selectedRowIndex == element.id }"
                                    (click)="highlight(element)">
                                </tr>
                                <tr mat-row *matRowDef="let row; columns: ['expandedDetail']"
                                    class="example-detail-row">
                                </tr>
                                <tr mat-row *matRowDef="let row; columns: ['reports']" class="example-detail-row">
                                </tr>
                            </table>
                        </section>
                    </div>
                </c-card-body>
            </c-card>
            <div *ngIf="Prescription.length==0">
                <hr>
                <p
                    style="margin-top: 20px; text-align: center;align-items: center;justify-content: center;font-size: 25px;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;font-weight: bold;">
                    Patient has no History
                </p>
            </div>
        </div>
    </div>
</div>