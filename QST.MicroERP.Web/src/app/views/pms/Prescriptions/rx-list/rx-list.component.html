<div class="container-fluid page">
    <div class="d-flex page_box p-3 mt-2">Patient Visits</div>
    <div class="page_content shadow p-3 position-relative">
        <div class="pull-right" style="text-align:end; margin-top: 20px;">
            <button [ngClass]="{disabledBtn:isReadOnly}" class="bttn"
                [routerLink]="['/pms/rx/prescription']">Add New</button>
            <!-- <mat-checkbox name="isActive" [(ngModel)]="selectedRow.isActive" (change)="Check()">
                IsActive
            </mat-checkbox> -->
            <button mat-icon-button mat-sm-button color="primary" cTooltip="Refresh  List" (click)="ngOnInit()">
                <mat-icon>autorenew</mat-icon>
            </button>
        </div>
        <div style="text-align:center;padding-top: 20px; justify-content: center;align-items: center;">
            <mat-form-field appearance="outline" class="custom-theme" fxFlex="100%">
                <mat-label> Select Patient</mat-label>
                <mat-select (selectionChange)="SearchByDates()" name="patientId" matNativeControl #patientId="ngModel"
                    [(ngModel)]="selectedRx.patientId">
                    <mat-option>
                        <ngx-mat-select-search (ngModelChange)="AutoCompleteSearch($event)" [(ngModel)]="searchValue"
                            name="searchValue" [noEntriesFoundLabel]="'No Matching Found'" [hideClearSearchButton]=true
                            placeholderLabel="Search Patient..." [clearSearchInput]=false
                            (blur)="AutoCompleteSearch($event)">
                        </ngx-mat-select-search>
                    </mat-option>
                    <mat-option [value]="0">
                        --Please Select--</mat-option>
                    <mat-option *ngFor="let patient of filteredData" [value]=" patient.id">
                        <strong>{{ patient.patientName ? (patient.patientName + ' ') : '' }}</strong>
                        {{ patient.dateOfBirth ? ('(DOB: ' + (patient.dateOfBirth |date:'yyyy-MM-dd') +
                        ') ') : '' }}
                        {{ patient.age ? ('(Age: ' + patient.age + ') ') : '' }}
                        {{ patient.gender ? ('(Gender: ' + patient.gender + ') ') : '' }}
                        {{ patient.contactNo ? ('(ContactNo: ' + patient.contactNo +') ') : '' }}
                        {{ patient.city ? ('(City: ' + patient.city + ') ') : '' }}
                        {{ patient.area ? ('(Area: ' + patient.area + ') ') : '' }}
                        {{ patient.address ? ('(Address: ' + patient.address + ') ') : '' }}
                        {{ patient.houseNo ? ('(House #: ' + patient.houseNo + ') ') : '' }}
                        <hr>
                    </mat-option>
                </mat-select>
            </mat-form-field>
        </div>
        <div style="text-align:center;padding-top: 10px;">
            <mat-form-field appearance="outline" class="custom-theme" fxFlex="50%">
                <mat-label>From Date</mat-label>
                <input matInput [matDatepicker]="startDateDP" name="from" [(ngModel)]="selectedRx.from" readonly
                    [max]="curDate">
                <mat-datepicker-toggle matSuffix [for]="startDateDP"></mat-datepicker-toggle>
                <mat-datepicker #startDateDP (closed)="SearchByDates()"></mat-datepicker>
            </mat-form-field>
            <!-- <mat-form-field style="margin-left:10px"> -->
            <mat-form-field appearance="outline" class="custom-theme" fxFlex="50%">
                <mat-label>To Date</mat-label>
                <input matInput [matDatepicker]="endDateDP" [min]="selectedRx.from" name="to" readonly
                    [(ngModel)]="selectedRx.to">
                <mat-datepicker-toggle matSuffix [for]="endDateDP"></mat-datepicker-toggle>
                <mat-datepicker #endDateDP (closed)="SearchByDates()"></mat-datepicker>
            </mat-form-field>
            <!-- <button mat-icon-button cTooltip="Get record  in Date Range" (click)="onBlur()">
                                <mat-icon>search</mat-icon>
                            </button> -->
        </div>
        <c-card style="padding: 10px; margin-top: 30px;" class="mat-elevation-z8">
            <c-card-body
                style="padding: 10px;background-image: linear-gradient(to bottom, rgb(2, 33, 58), rgb(7, 95, 122));margin: 5px;border-radius: 10px;">
                <div class="example-table-container">
                    <section class="example-container mat-elevation-z8" tabindex="0" style="border-radius: 5px;">
                        <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="mat-elevation-z8">
                            <ng-container matColumnDef="expand" sticky="true">
                                <th mat-header-cell *matHeaderCellDef aria-label="row actions">
                                    <div style="width: 50px;">&nbsp;</div>
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div *ngIf="element.rxMedicines.length>0 || element.reports.length>0">
                                        <button mat-icon-button aria-label="expand row"
                                            (click)="(expandedElement = expandedElement === element ? null : element); $event.stopPropagation();highlight(element)">
                                            <mat-icon *ngIf="expandedElement !== element">keyboard_arrow_down</mat-icon>
                                            <mat-icon *ngIf="expandedElement === element">keyboard_arrow_up</mat-icon>
                                        </button>
                                    </div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="Id">
                                <th mat-header-cell *matHeaderCellDef> Sr No </th>
                                <td mat-cell *matCellDef="let element"> {{element.id}} </td>
                            </ng-container>
                            <ng-container matColumnDef="tokenNo">
                                <th mat-header-cell *matHeaderCellDef>
                                    <div style="min-width: 100px;"> Token No </div>
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div style="min-width: 100px;"> {{element.tokenNo}}</div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="patient">
                                <th mat-header-cell class="mat-cell" *matHeaderCellDef>
                                    <div style="min-width: 90px;"> Patient </div>
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div style="min-width: 90px;"> {{element.patient}}</div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="doctor">
                                <th mat-header-cell class="mat-cell" *matHeaderCellDef>
                                    <div style="min-width: 150px;"> Doctor </div>
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div style="min-width: 150px;"> {{element.doctor}}</div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="time">
                                <th mat-header-cell class="mat-cell" *matHeaderCellDef>
                                    <div style="min-width: 150px;"> Time </div>
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div style="min-width: 150px;"> {{element.time}}</div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="amount">
                                <th mat-header-cell *matHeaderCellDef>
                                    <div style="min-width: 90px;">Fees</div>
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div style="min-width: 90px;"> {{element.amount}}</div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="remarks">
                                <th mat-header-cell *matHeaderCellDef>
                                    <div style="min-width: 150px;"> Remarks </div>
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div style="min-width: 150px;">{{element.remarks}}</div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="date">
                                <th mat-header-cell *matHeaderCellDef>
                                    <div style="min-width: 150px;"> Date </div>
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div style="min-width: 150px;">{{element.date|date:"dd/MM/yyyy"}}</div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="ecg">
                                <th mat-header-cell *matHeaderCellDef>
                                    <div style="min-width: 150px;max-width: 1000px;">ECG</div>
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div style="min-width: 150px;max-width: 1000px;">{{element.ecg}}</div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="bp">
                                <th mat-header-cell *matHeaderCellDef>
                                    <div style="min-width: 150px;"> BP</div>
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div style="min-width: 150px;"> {{element.bp}}</div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="weight">
                                <th mat-header-cell *matHeaderCellDef>
                                    <div style="min-width: 150px;">Weight</div>
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div style="min-width: 150px;">{{element.weight}}</div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="temperature">
                                <th mat-header-cell *matHeaderCellDef>
                                    <div style="min-width: 150px;"> Temperature</div>
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div style="min-width: 150px;"> {{element.temperature}}</div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="isActive">
                                <th mat-header-cell *matHeaderCellDef>
                                    <div style="min-width: 50px;font-size: 14px;">IsActive</div>
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div style="min-width: 50px;">{{element.isActive?'Yes':'No'}}</div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="Action" stickyEnd="true">
                                <th mat-header-cell *matHeaderCellDef
                                    style="min-width: 150px; text-align: center;margin-left: 0;margin-right: 0;">
                                    <div style="font-size: 14px;">Actions</div>
                                </th>
                                <td mat-cell *matCellDef="let row"
                                    style="min-width: 150px;text-align: center;margin-left: 0;margin-right: 0;">
                                    <div [ngClass]="{disabledDiv:isReadOnly}">
                                            <mat-icon [ngClass]="{disabledIcon:isReadOnly}" class="primaryIcon" (click)="EditPrescription(row)" matTooltip="Edit">edit</mat-icon>
                                            <mat-icon [ngClass]="{disabledIcon:isReadOnly}" class="redIcon" (click)="openPdf(row)" cTooltip="Open Pdf">picture_as_pdf</mat-icon>
                                        <mat-icon [ngClass]="{disabledIcon:isReadOnly}" class="blueIcon"  (click)="sendMail(row)"
                                        cTooltip="Send Email">email</mat-icon>
                                        <!-- <button mat-icon-button mat-sm-button color="warn" matTooltip="Delete"
                                                    (click)="DeletePrescription(row.id)"><mat-icon>delete</mat-icon></button> -->
                                    </div>
                                </td>
                            </ng-container>
                            <ng-container *ngFor="let column of extraColumns">
                                <ng-container matColumnDef="{{ column }}" style="min-width: 200px;white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;">
                                    <th mat-header-cell *matHeaderCellDef >
                                        {{ column | titlecase }}
                                    </th>
                                    <td mat-cell *matCellDef="let element" style="min-width: 200px;white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;">
                                        {{ getCellValue(element, column) }}
                                    </td>
                                </ng-container>
                            </ng-container>

                            <ng-container matColumnDef="expandedDetail">
                                <td mat-cell *matCellDef="let element"
                                    [attr.colspan]="columnsToDisplayWithExpand.length">
                                    <div class="example-element-detail" *ngIf="element.rxMedicines.length>0"
                                        style="align-items: center; border-radius: 30px;"
                                        [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
                                        <div *ngIf="expandedElement">
                                            <section class="example-container mat-elevation-z8" tabindex="0"
                                                style="margin-left: 70px;margin-top: 30px;
                                               text-align: center; margin-bottom: 30px; border-radius: 30px;width: 55%;">
                                                <h3>Medicine Detail</h3>
                                                <table #innerTables mat-table [dataSource]="element.rxMedicines"
                                                    class="mat-elevation-z8" style=" overflow: auto;">
                                                    <ng-container matColumnDef="medicine">
                                                        <th mat-header-cell *matHeaderCellDef>
                                                            <div style="min-width: 150px;">Medicine</div>
                                                        </th>
                                                        <td mat-cell *matCellDef="let element">
                                                            <div style="min-width: 150px;">{{element.medicine}}</div>
                                                        </td>
                                                    </ng-container>
                                                    <ng-container matColumnDef="mr">
                                                        <th mat-header-cell *matHeaderCellDef>
                                                            <div style="min-width: 150px;"> Meal Relation</div>
                                                        </th>
                                                        <td mat-cell *matCellDef="let element">
                                                            <div style="min-width: 150px;"> {{element.mr}}</div>
                                                        </td>
                                                    </ng-container>
                                                    <ng-container matColumnDef="amQty">
                                                        <th mat-header-cell *matHeaderCellDef>
                                                            <div style="min-width: 150px;"> Morning Qty</div>
                                                        </th>
                                                        <td mat-cell *matCellDef="let element">
                                                            <div style="min-width: 150px;"> {{element.amQty}}</div>
                                                        </td>
                                                    </ng-container>
                                                    <ng-container matColumnDef="noonQty">
                                                        <th mat-header-cell *matHeaderCellDef>
                                                            <div style="min-width: 150px;"> Noon Qty</div>
                                                        </th>
                                                        <td mat-cell *matCellDef="let element">
                                                            <div style="min-width: 150px;">{{element.noonQty}}</div>
                                                        </td>
                                                    </ng-container>
                                                    <ng-container matColumnDef="eveQty">
                                                        <th mat-header-cell *matHeaderCellDef>
                                                            <div style="min-width: 150px;"> Evening Qty</div>
                                                        </th>
                                                        <td mat-cell *matCellDef="let element">
                                                            <div style="min-width: 150px;">{{element.eveQty}}</div>
                                                        </td>
                                                    </ng-container>
                                                    <ng-container matColumnDef="days">
                                                        <th mat-header-cell *matHeaderCellDef>
                                                            <div style="min-width: 150px;"> Days</div>
                                                        </th>
                                                        <td mat-cell *matCellDef="let element">
                                                            <div style="min-width: 150px;">{{element.days}}</div>
                                                        </td>
                                                    </ng-container>
                                                    <ng-container matColumnDef="remarks">
                                                        <th mat-header-cell *matHeaderCellDef>
                                                            <div style="min-width: 150px;"> Remarks</div>
                                                        </th>
                                                        <td mat-cell *matCellDef="let element">
                                                            <div style="min-width: 150px;">{{element.remarks}}</div>
                                                        </td>
                                                    </ng-container>
                                                    <tr mat-header-row *matHeaderRowDef="innerDisplayedColumns"></tr>
                                                    <tr mat-row *matRowDef="let row; columns: innerDisplayedColumns;">
                                                    </tr>
                                                </table>
                                            </section>
                                        </div>
                                    </div>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="reports">
                                <td mat-cell *matCellDef="let element"
                                    [attr.colspan]="columnsToDisplayWithExpand.length">
                                    <div class="example-element-detail" *ngIf="element.reports.length>0"
                                        style="align-items: center; border-radius: 30px;"
                                        [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
                                        <div *ngIf="expandedElement">
                                            <section class="example-container mat-elevation-z8" tabindex="0"
                                                style="margin-left: 70px;margin-top: 30px;
                                                margin-bottom: 30px;border-radius: 30px;width: 100%;text-align: center;">
                                                <h3>Reports</h3>
                                                <table #innerTables mat-table [dataSource]="element.reports"
                                                    class="mat-elevation-z8" style=" overflow: auto;">
                                                    <ng-container matColumnDef="date">
                                                        <th mat-header-cell *matHeaderCellDef
                                                            class="custom-sort-header"> Date</th>
                                                        <td mat-cell *matCellDef="let element">
                                                            {{element.date|date:"dd/MM/yyyy"}}
                                                        </td>
                                                    </ng-container>
                                                    <ng-container matColumnDef="category">
                                                        <th mat-header-cell *matHeaderCellDef
                                                            class="custom-sort-header">Category </th>
                                                        <td mat-cell *matCellDef="let element"> {{element.category}}
                                                        </td>
                                                    </ng-container>
                                                    <ng-container matColumnDef="actions" stickyEnd style="z-index: 0;">
                                                        <th mat-header-cell *matHeaderCellDef
                                                            style="width: 70px; text-align: center;">
                                                            <div>Actions</div>
                                                        </th>
                                                        <td mat-cell *matCellDef="let row"
                                                            style="width: 70px;text-align: center;">
                                                            <div [ngClass]="{disabledDiv:isReadOnly}">
                                                                <a href="javascript:void(0);" cTooltip="View Report "
                                                                    (click)="openReportInNewPage(row.reportBase64Path)"
                                                                    class="popup-link">
                                                                    <mat-icon class="viewBtn" [ngClass]="{disabledIcon:isReadOnly}"
                                                                        >visibility</mat-icon>
                                                                </a>
                                                                <a [href]="row.reportBase64Path" download>
                                                                    <mat-icon class="downloadBtn" [ngClass]="{disabledIcon:isReadOnly}" cTooltip="Download Report"
                                                                        >download</mat-icon>
                                                                </a>
                                                            </div>
                                                        </td>
                                                    </ng-container>
                                                    <tr mat-header-row *matHeaderRowDef="rptDisplayedCol"></tr>
                                                    <tr mat-row *matRowDef="let row; columns: rptDisplayedCol;">
                                                    </tr>
                                                </table>
                                            </section>
                                        </div>
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="header-row-first-group">
                                <th mat-header-cell *matHeaderCellDef [attr.colspan]="8">
                                    <div style=" width: 100%;">.</div>
                                </th>
                            </ng-container>
                            <ng-container matColumnDef="header-row-second-group" stickyEnd="true">
                                <th mat-header-cell *matHeaderCellDef style="text-align: center;" [attr.colspan]="3">
                                    <div style=" width: 100%;">Actions</div>

                                </th>
                            </ng-container>
                            <!-- <tr mat-header-row style="height:10px ; "
                                *matHeaderRowDef="['header-row-first-group', 'header-row-second-group']"></tr> -->
                            <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
                            <tr mat-row *matRowDef="let element; columns: columnsToDisplayWithExpand;"
                                class="example-element-row" [class.example-expanded-row]="expandedElement === element"
                                [ngClass]="{'highlight': selectedRowIndex == element.id }" (click)="highlight(element)">
                            </tr>
                            <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row">
                            </tr>
                            <tr mat-row *matRowDef="let row; columns: ['reports']" class="example-detail-row">
                            </tr>
                        </table>
                    </section>
                </div>
            </c-card-body>
        </c-card>
    </div>
</div>
<div>
    <div *ngIf="isLoading" class="lightbox">
        <c-spinner style="height: 100px;width: 100px;color: white;"></c-spinner>
    </div>
</div>
