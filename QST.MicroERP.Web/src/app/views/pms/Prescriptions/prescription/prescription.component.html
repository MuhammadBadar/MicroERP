<div class="container-fluid page">
    <div class="d-flex page_box p-3 mt-2  header-sticky" position="sticky">
        <div fxLayout="row" fxLayoutAlign="space-between" fxFlex="100%">
            <div *ngIf="Add ">Manage Patient Visit
            </div>
            <div *ngIf="Edit ">Update Patient Visit
            </div>
            <div *ngIf="viewMode ">View Patient Visit
            </div>
            <div fxFlex="7%" *ngIf="viewMode">
                <button mat-icon-button fxLayoutAlign="end end" (click)="_dialogRef.close()" style="color: white">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
        </div>
    </div>
    <div class="page_content shadow p-3 position-relative">
        <form #PrescriptionForm="ngForm" (keydown.enter)="$event.preventDefault()">
            <div>
                <div fxLayoutAlign="space-between" style="margin-bottom: 20px;">
                    <div fxFlex="50%">
                        <c-spinner *ngIf="proccessing"
                            style="height: 50px;width: 50px;color: rgb(3, 71, 102);"></c-spinner>
                        <div *ngIf="!viewMode && !proccessing">
                            <!-- <button *ngIf="Add" mat-fab extended
                                style="background-color:#04294e ;color: white;margin: 4px;" (click)="Submit();">
                                <mat-icon>check_circle</mat-icon> Submit
                            </button> -->
                            <mat-button-toggle-group style="background: none;" >
                                <mat-button-toggle style="background-color:#4e4c4c ;color: white;margin: 5px;"  (click)="Back();"> <mat-icon>arrow_back</mat-icon>
                                    Back</mat-button-toggle>
                              </mat-button-toggle-group>
                            <mat-button-toggle-group *ngIf="Add"  [ngClass]="{disIconBtn:isReadOnly}" >
                                <mat-button-toggle  class="split-button-1 submit-btn" [ngClass]="{splitbutton1dis:isReadOnly}" (click)="Submit();"> <mat-icon>check_circle</mat-icon> Submit</mat-button-toggle>
                                <mat-button-toggle class="split-button-1 drop-down-button" [ngClass]="{splitbutton1dis:isReadOnly}" [matMenuTriggerFor]="dropdownMenuOne">
                                  <mat-icon>arrow_drop_down</mat-icon>
                                </mat-button-toggle>
                              </mat-button-toggle-group>
                              <mat-button-toggle-group *ngIf="Edit" [ngClass]="{disIconBtn:isReadOnly}">
                                <mat-button-toggle class="split-button-1 submit-btn" [ngClass]="{splitbutton1dis:isReadOnly}" (click)="Submit();"> <mat-icon>check_circle</mat-icon> Update</mat-button-toggle>
                                <mat-button-toggle class="split-button-1 drop-down-button" [ngClass]="{splitbutton1dis:isReadOnly}" [matMenuTriggerFor]="dropdownMenuTwo">
                                  <mat-icon>arrow_drop_down</mat-icon>
                                </mat-button-toggle>
                              </mat-button-toggle-group>
                              
                              <mat-menu #dropdownMenuOne="matMenu" xPosition="before">
                                <button  type="submit" mat-menu-item  class="menu-item" (click)="isSendMail=true;Submit();">
                                    <mat-icon class="menu-item-icon">email</mat-icon>
                                    <span class="menu-item-text">Save & Mail</span>
                                  </button>
                                  <button  type="submit" mat-menu-item  class="menu-item" (click)="isPrint=true;Submit()">
                                    <mat-icon class="menu-item-icon">picture_as_pdf</mat-icon>
                                    <span class="menu-item-text">Save & Pdf</span>
                                  </button>
                              </mat-menu>
                              <mat-menu #dropdownMenuTwo="matMenu" xPosition="before">
                                <button  type="submit" mat-menu-item  class="menu-item" (click)="isSendMail=true;Submit();">
                                    <mat-icon class="menu-item-icon">email</mat-icon>
                                    <span class="menu-item-text">Update & Mail</span>
                                  </button>
                                  <button  type="submit" mat-menu-item  class="menu-item" (click)="isPrint=true;Submit();">
                                    <mat-icon class="menu-item-icon">picture_as_pdf</mat-icon>
                                    <span class="menu-item-text">Update & Pdf</span>
                                  </button>
                              </mat-menu>
                            <!-- <button *ngIf="Edit" mat-fab extended
                                style="background-color:#04294e ;color: white;margin: 4px;" (click)="Submit();">
                                <mat-icon>check_circle</mat-icon> Update
                            </button> -->
                            <button mat-icon-button mat-sm-button color="primary" cTooltip="Refresh"
                                cTooltipPlacement="top" (click)="ngOnInit()" *ngIf="Add">
                                <mat-icon>autorenew</mat-icon>
                            </button>
                        </div>
                    </div>
                    <div fxLayoutAlign="end end" *ngIf="selectedPrescription.patientId > 0">
                        <button *ngIf="!viewMode" mat-fab extended [ngClass]="{disIconBtn:isReadOnly}"
                            class="icon-button" (click)=" PatHistoryDialog()">
                            <mat-icon>history</mat-icon>
                            Patient History
                        </button>
                    </div>
                </div>
                <div fxLayoutAlign="space-between">
                    <div fxLayout="row" fxFlex="47%">
                        <div fxFlex="10%" *ngIf="selectedPrescription.doctorId>0 && !viewMode">
                            <mat-icon (click)="OpenDocAppointments()"
                                style="cursor: pointer;color: #04415e;margin-top: 13px;">event</mat-icon>
                        </div>
                        <mat-form-field [inert]="viewMode || Edit ||isReadonly" fxFlex="90%" appearance="outline"
                            class="form-group">
                            <mat-label> Select Doctor</mat-label>
                            <mat-select name="doctorId" matNativeControl #doctorId="ngModel" required
                                [(ngModel)]="selectedPrescription.doctorId">
                                <mat-option>
                                    <ngx-mat-select-search (ngModelChange)="DocAutoCompleteSearch($event)"
                                        [(ngModel)]="docSearchValue" name="searchValue"
                                        [noEntriesFoundLabel]="'No Matching Found'" [hideClearSearchButton]=true
                                        placeholderLabel="Search Doctor..." [clearSearchInput]=false
                                        (blur)="DocAutoCompleteSearch($event)">
                                    </ngx-mat-select-search>
                                </mat-option>
                                <mat-option [value]="0">
                                    --Please Select--</mat-option>
                                <mat-option *ngFor="let doctor of filteredDocData" [value]=" doctor.id"
                                    (click)="resetAppt();GetNextToken() ">
                                    <strong>{{ doctor.doctorName ? (doctor.doctorName + ' ') : '' }}</strong>
                                    {{ doctor.contactNo ? ('(ContactNo: ' + doctor.contactNo +') ') : '' }}
                                    {{ doctor.city ? ('(City: ' + doctor.city + ') ') : '' }}
                                    {{ doctor.area ? ('(Area: ' + doctor.area + ') ') : '' }}
                                    {{ doctor.address ? ('(Address: ' + doctor.address + ') ') : '' }}
                                    {{ doctor.houseNo ? ('(House #: ' + doctor.houseNo + ') ') : '' }}
                                    <hr>
                                </mat-option>
                            </mat-select>
                            <div matSuffix [ngClass]="{disabledDiv:isReadOnly}">
                                <button mat-icon-button style="color:#940540;"
                                    (click)="OpenDoctorDialog(); $event.stopPropagation()" cTooltip="Explore Doctor">
                                    <mat-icon>add</mat-icon>
                                </button>
                            </div>
                        </mat-form-field>
                    </div>
                    <div fxFlex="40%" fxLayoutAlign="space-around" *ngIf="selectedPrescription.doctorId>0">
                        <div [inert]="(viewMode || Edit)" fxFlex="30%" *ngIf="!viewMode">
                            <button *ngIf="!Edit" class="icon-button" style="height: 60px;  
                               display: flex;
                               align-items: center; 
                               justify-content: center;"
                               [ngClass]="{disIconBtn:isReadOnly}" fxFlex="100%" (click)="GetPreToken()">
                                <i class="fa fa-arrow-left"></i>&nbsp; Previous
                            </button>
                        </div>
                        <mat-form-field fxFlex="40%" [inert]="viewMode || Edit" appearance="outline" class="form-group"
                            style="margin-top: 3px;" *ngIf="!Edit && !viewMode">
                             <span matPrefix style="margin-left: 10px;"><b>{{ getTokenPrefix() }}</b></span>
                            <mat-label>Token No</mat-label>
                            <input min="1" type="number" style="color: #940540;font-weight: bolder;font-size: large;" matInput
                                #tokenId="ngModel" (keypress)="validateNo($event)" (blur)="SearchAppt()" name="tokenId"
                                [(ngModel)]="selectedPrescription.tokenId" required="true" />
                        </mat-form-field>
                        <div [inert]="viewMode || Edit" fxFlex="30%" *ngIf="!viewMode">
                            <button [ngClass]="{disIconBtn:isReadOnly}" style="height: 60px; 
                               display: flex;
                               align-items: center; 
                               justify-content: center;" 
                               fxFlex="100%" class="icon-button" (click)="GetNextToken()"
                                *ngIf="!Edit">
                                Next &nbsp;<i class="fa fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <c-card style="padding: 10px; margin-top: 20px; background:  rgb(209, 238, 243);padding: 20px;"
                    class="mat-elevation-z8" [inert]="viewMode">
                    <Row [inert]="viewMode || Edit">
                        <div fxLayout="row" fxFlex="100%">
                            <mat-form-field fxFlex="50%" appearance="outline" class="form-group">
                                <mat-label> Date</mat-label>
                                <input
                                    [min]="utcToLocalDate(selectedPrescription.date)>minDate?minDate:selectedPrescription.date"
                                    matInput [matDatepicker]="pickerFrom" name="date" readonly="true" #date="ngModel"
                                    [(ngModel)]="selectedPrescription.date" />
                                <mat-datepicker-toggle matSuffix [for]="pickerFrom"></mat-datepicker-toggle>
                                <mat-datepicker #pickerFrom (closed)="onBlur()"></mat-datepicker>
                            </mat-form-field>
                            <mat-form-field fxFlex="50%" appearance="outline">
                                <mat-label>Time </mat-label>
                                <input matInput [ngxTimepicker]="end" #time="ngModel" name="Time"
                                    [(ngModel)]="selectedPrescription.time" required readonly [format]="12" />
                                <ngx-material-timepicker [timepickerClass]="'custome-class'" (closed)="onBlur()" #end>
                                </ngx-material-timepicker>
                            </mat-form-field>
                        </div>
                    </Row>
                    <Row [inert]="viewMode || Edit">
                        <div fxLayout="row" fxFlex="100%">
                            <mat-form-field appearance="outline" style="width: 85%;" class="custom-theme">
                                <mat-label> Select Patient</mat-label>
                                <mat-select name="patientId" matNativeControl #patientId="ngModel" required
                                    [(ngModel)]="selectedPrescription.patientId"
                                    [disabled]="(selectedPrescription.doctorId>0 && selectedPrescription.tokenId>0) ">
                                    <mat-option>
                                        <ngx-mat-select-search (ngModelChange)="AutoCompleteSearch($event)"
                                            [(ngModel)]="searchValue" name="searchValue"
                                            [noEntriesFoundLabel]="'No Matching Found'" [hideClearSearchButton]=true
                                            placeholderLabel="Search Patient..." [clearSearchInput]=false
                                            (blur)="AutoCompleteSearch($event)">
                                        </ngx-mat-select-search>
                                    </mat-option>
                                    <mat-option [value]="0">
                                        --Please Select--</mat-option>
                                    <mat-option (click)="GetAptByPatient()" *ngFor="let patient of filteredData"
                                        [value]="patient.id">
                                        <strong>{{ patient.patientName ? (patient.patientName + ' ') : '' }}</strong>
                                        {{ patient.dateOfBirth ? ('(DOB: ' + (patient.dateOfBirth | date:'yyyy-MM-dd') +
                                        ') ') : '' }}
                                        {{ patient.age ? ('(Age: ' + patient.age + ') ') : '' }}
                                        {{ patient.gender ? ('(Gender: ' + patient.gender + ') ') : '' }}
                                        {{ patient.contactNo ? ('(ContactNo: ' + patient.contactNo +') ') : '' }}
                                        {{ patient.city ? ('(City: ' + patient.city + ') ') : '' }}
                                        {{ patient.area ? ('(Area: ' + patient.area + ') ') : '' }}
                                        {{ patient.address ? ('(Address: ' + patient.address + ') ') : '' }}
                                        {{ patient.houseNo ? ('(House #: ' + patient.houseNo + ') ') : '' }}
                                        <hr>
                                    </mat-option>
                                </mat-select>
                                <div matSuffix [ngClass]="{disabledDiv:isReadOnly}">
                                    <button mat-icon-button style="color:#940540;"
                                        (click)="OpenPatientDialog(); $event.stopPropagation()"
                                        cTooltip="Explore Patient">
                                        <mat-icon>add</mat-icon>
                                    </button>
                                </div>
                            </mat-form-field>
                            <mat-form-field fxFlex="15%" appearance="outline" class="form-group">
                                <mat-label>Fees</mat-label>
                                <input min="0" matInput #amount="ngModel" type="number" oninput="validity.valid||(value='')"
                                    (blur)="onBlur()" name="Fee" [(ngModel)]="selectedPrescription.amount"
                                    required="true" />
                                <span matSuffix style="margin-right: 8px;">PKR</span>
                            </mat-form-field>
                        </div>
                    </Row>
                    <Row>
                        <div fxLayout="row" fxFlex="100%">
                            <mat-form-field appearance="outline" fxFlex="100%">
                                <mat-label>Remarks</mat-label>
                                <textarea maxlength="65535" matInput #remarks="ngModel" (blur)="onBlur()" name="remarks" rows="1"
                                    [(ngModel)]="selectedPrescription.remarks"></textarea>
                            </mat-form-field>
                        </div>
                    </Row>
                </c-card>
                <Row [inert]="viewMode" fxLayoutAlign="end end" style="margin: 20px;">
                    <mat-checkbox name="isActive" [(ngModel)]="selectedPrescription.isActive" (change)="onBlur()">
                        IsActive
                    </mat-checkbox>
                </Row>
                <mat-tab-group animationDuration="500ms" style="margin: 50px;" [(selectedIndex)]="TabIndex">
                    <mat-tab label="Patient Stats">
                        <c-card [inert]="viewMode" style="margin-top: 40px;padding: 40px;" class="mat-elevation-z8 tab">
                            <c-card style="padding: 10px; background:  rgb(209, 238, 243);padding: 20px;"
                                class="mat-elevation-z8">
                                <Row style="margin:0px 10px 0px 10px">
                                    <div fxLayout="row" fxFlex="100%">
                                        <mat-form-field fxFlex="50%" appearance="outline" class="form-group">
                                            <mat-label>Temperature</mat-label>
                                            <input  maxlength="65535" matInput #temperature="ngModel" (blur)="onBlur()" name="Temperature"
                                                [(ngModel)]="selectedPrescription.temperature" required="true" />
                                        </mat-form-field>
                                                <mat-form-field fxFlex="50%" appearance="outline" class="form-group">
                                            <mat-label>Weight</mat-label>
                                            <input  maxlength="65535" matInput #weight="ngModel" (blur)="onBlur()" name="Weight"
                                                [(ngModel)]="selectedPrescription.weight" required="true" />
                                        </mat-form-field>
                                    </div>
                                </Row>
                                <Row style="margin:0px 10px 0px 10px">
                                    <div fxLayout="row" fxFlex="100%">
                                          <mat-form-field appearance="outline" fxFlex="50%">
                        <mat-label>BP </mat-label>
                        <mat-select name="bpStatusId" [(ngModel)]="selectedPrescription.bpStatusId">
                            <mat-option [value]="0">--Please Select--</mat-option>
                            <mat-option *ngFor="let val of bpStatuses" [value]="val.id" (click)="onBlur()">
                                {{val.name}}
                            </mat-option>
                        </mat-select>
                                        </mat-form-field>
                                         <mat-checkbox (click)="onBlur()"name="isSugarPatient" [(ngModel)]="selectedPrescription.isSugarPatient" checked>Is Sugar Patient</mat-checkbox>
                                        </div>
                                </Row>
                                <div class="container">
                                    <div class="row courses-row">
                                        <div class="col-lg-12" *ngFor="let formData of fields" [formGroup]="group"
                                            [ngSwitch]="true">
                                            <div *ngSwitchCase="formData.keyCode === 'Drop Down'">
                                                <mat-form-field class="demo-full-width margin-top" appearance="outline"
                                                    fxFlex="100%">
                                                    <mat-label>{{formData.name}}</mat-label>
                                                    <mat-select [required]="formData.isRequired"
                                                        [placeholder]="formData.name" (closed)="onBlur()"
                                                        name="formData.name" [formControlName]="formData.id">
                                                        <mat-option *ngFor="let item of formData.settingList"
                                                            [value]="item.name">
                                                            {{ item.name }}
                                                        </mat-option>
                                                    </mat-select>
                                                </mat-form-field>
                                            </div>
                                            <div *ngSwitchCase="formData.keyCode === 'DatePicker'">
                                                <mat-form-field class="demo-full-width margin-top" fxFlex="100%"
                                                    appearance="outline">
                                                    <input [required]="formData.isRequired" matInput
                                                        name="formData.name" [matDatepicker]="picker"
                                                        [formControlName]="formData.id" [placeholder]="formData.name" />
                                                    <mat-datepicker-toggle matSuffix
                                                        [for]="picker"></mat-datepicker-toggle>
                                                    <mat-datepicker #picker></mat-datepicker>
                                                    <mat-hint></mat-hint>
                                                </mat-form-field>
                                            </div>
                                            <div *ngSwitchCase="formData.keyCode === 'Text Area'">
                                                <mat-form-field class="demo-full-width" fxFlex="100%"
                                                    appearance="outline">
                                                    <mat-label>{{formData.name}}</mat-label>
                                                    <textarea  maxlength="65535" (blur)="onBlur()" [required]="formData.isRequired"
                                                        name="formData.name" rows="1" matInput
                                                        [formControlName]="formData.id"
                                                        [placeholder]="formData.name"></textarea>
                                                </mat-form-field>
                                            </div>
                                            <div *ngSwitchCase="formData.keyCode === 'Text Box'">
                                                <mat-form-field class="demo-full-width" fxFlex="100%"
                                                    appearance="outline">
                                                    <mat-label>{{formData.name}}</mat-label>
                                                    <input [type]="formData.description"  maxlength="65535" (blur)="onBlur()" [required]="formData.isRequired"
                                                        name="formData.name" rows="1" matInput
                                                        [formControlName]="formData.id" [placeholder]="formData.name" />
                                                </mat-form-field>
                                            </div>
                                            <div *ngSwitchCase="formData.keyCode === 'Check Box'">
                                                <mat-checkbox name="formData.name" (click)="onBlur()"
                                                    [formControlName]="formData.id">{{formData.name}}
                                                </mat-checkbox>
                                            </div>
                                            <div *ngSwitchCase="formData.keyCode === 'Radio Button'">
                                                <mat-radio-group (change)="onBlur()" [formControlName]="formData.id"
                                                    fxFlex="100%" appearance="outline" [required]="formData.isRequired">
                                                    <mat-label>{{formData.name}}
                                                        <span class="required-asterisk" *ngIf="formData.isRequired">*
                                                        </span> :</mat-label>
                                                    <!-- <mat-radio-label>{{formData.name}}:</mat-radio-label> -->
                                                    <mat-radio-button style="margin-left:30px"
                                                        *ngFor="let item of formData.settingList" [value]="item.name">
                                                        {{
                                                        item.name }}
                                                    </mat-radio-button>
                                                </mat-radio-group>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </c-card>
                        </c-card>
                    </mat-tab>
                    <mat-tab label="Medicine Details">
                        <c-card style="margin-top: 40px;padding: 40px;" class="mat-elevation-z8 tab">
                            <h5 style="font-size:20px;  color: #04415e;margin: 20px;" *ngIf="!viewMode">
                                <div *ngIf="!lineEditMode">Manage Medicine Detail</div>
                                <div *ngIf="lineEditMode">Update Medicine Detail</div>
                            </h5>
                            <form #medForm="ngForm" (keydown.enter)="$event.preventDefault()">
                                <c-card *ngIf="!viewMode"
                                    style="padding: 10px;  background:  rgb(209, 238, 243);padding: 20px;"
                                    class="mat-elevation-z8">
                                    <Row>
                                        <div fxLayout="row" fxFlex="100%">
                                            <mat-form-field fxFlex="100%" appearance="outline" class="form-group">
                                                <mat-label> Select Medicine</mat-label>
                                                <mat-select name="medId" required="true" matNativeControl
                                                    #medId="ngModel" [(ngModel)]="selectedRxMedicine.medId">
                                                    <mat-option>
                                                        <ngx-mat-select-search
                                                            (ngModelChange)="MedAutoCompleteSearch($event)"
                                                            [(ngModel)]="medSearchValue" name="medSearchValue"
                                                            [noEntriesFoundLabel]="'No Matching Found'"
                                                            [hideClearSearchButton]=true
                                                            placeholderLabel="Search Medicine..."
                                                            [clearSearchInput]=false
                                                            (blur)="MedAutoCompleteSearch($event)">
                                                        </ngx-mat-select-search>
                                                    </mat-option>
                                                    <!-- <mat-option [value]="0">
                                                        --Please Select--</mat-option> -->
                                                    <mat-option *ngFor="let med of filteredMedData" [value]=" med.id">
                                                        <strong>{{ med.name ? (med.name + ' ') : '' }}</strong>
                                                        {{ med.manufacturer ? ('(Manufacturer: ' + med.manufacturer + ')'): '' }}
                                                        {{ med.formula ? ('(Formula: ' + med.formula + ') ') : '' }}
                                                        {{ med.category ? ('(Category: ' + med.category +') ') : '' }}
                                                        <hr>
                                                    </mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </div>
                                    </Row>
                                    <Row>
                                        <div fxLayout="row" fxFlex="100%">
                                            <mat-form-field fxFlex="50%" appearance="outline" class="form-group">
                                                <mat-label>Morning Qty</mat-label>
                                                <input matInput #amQty="ngModel" name="amQty"  maxlength="3" min="1" pattern="[0-9]*"
                                                    [(ngModel)]="selectedRxMedicine.amQty" type="number"
                                                    oninput="validity.valid||(value='')" />
                                            </mat-form-field>
                                            <mat-form-field fxFlex="50%" appearance="outline" class="form-group">
                                                <mat-label>Noon Qty</mat-label>
                                                <input matInput #noonQty="ngModel" name="noonQty" maxlength="3" min="1" pattern="[0-9]*"
                                                    [(ngModel)]="selectedRxMedicine.noonQty" type="number"
                                                    oninput="validity.valid||(value='')" />
                                            </mat-form-field>
                                        </div>
                                    </Row>
                                    <Row>
                                        <div fxLayout="row" fxFlex="100%">
                                            <mat-form-field fxFlex="35%" appearance="outline">
                                                <mat-label>Evening Qty</mat-label>
                                                <input matInput #eveQty="ngModel" name="eveQty"
                                                    [(ngModel)]="selectedRxMedicine.eveQty" type="number" maxlength="3" min="1" pattern="[0-9]*"
                                                    oninput="validity.valid||(value='')" />
                                            </mat-form-field>
                                            <mat-form-field fxFlex="35%" appearance="outline">
                                                <mat-label>Days</mat-label>
                                                <input matInput #days="ngModel" name="Days" required="true" maxlength="3" min="1" pattern="[0-9]*"
                                                    [(ngModel)]="selectedRxMedicine.days" type="number"
                                                    oninput="validity.valid||(value='')" />
                                            </mat-form-field>
                                            <mat-form-field fxFlex="35%" appearance="outline" class="form-group">
                                                <mat-label> Select Meal Relation</mat-label>
                                                <mat-select name="mrId" #mrId="ngModel" required="true"
                                                    [(ngModel)]="selectedRxMedicine.mrId">
                                                    <!-- <mat-option [value]="0">--Please Select--</mat-option> -->
                                                    <mat-option *ngFor="let pt of mRelations" [value]=" pt.id">
                                                        {{ pt.name}}
                                                    </mat-option>
                                                </mat-select>
                                                <div matSuffix [ngClass]="{disabledDiv:isReadOnly}">
                                                    <button mat-icon-button style="color:#940540;"
                                                        (click)="OpenMRDialog(); $event.stopPropagation()"
                                                        cTooltip="Explore Meal Relations">
                                                        <mat-icon>add</mat-icon>
                                                    </button>
                                                </div>
                                            </mat-form-field>
                                        </div>
                                    </Row>
                                    <Row>
                                        <div fxLayout="row" fxFlex="100%">
                                            <mat-form-field fxFlex="80%" appearance="outline" class="form-group">
                                                <mat-label>--Please Select Remarks--</mat-label>
                                                <mat-select name="remarksId" #remarksId="ngModel"
                                                    [(ngModel)]="selectedRxMedicine.remarksId">
                                                    <mat-option *ngFor="let pt of medRemarks" [value]=" pt.id">
                                                        {{ pt.name}}
                                                    </mat-option>
                                                </mat-select>
                                                <div matSuffix [ngClass]="{disabledDiv:isReadOnly}">
                                                    <button mat-icon-button style="color:#940540;"
                                                        (click)="OpenRemarksDialog(); $event.stopPropagation()"
                                                        cTooltip="Explore Remarks">
                                                        <mat-icon>add</mat-icon>
                                                    </button>
                                                </div>
                                            </mat-form-field>
                                            <button mat-icon-button mat-sm-button type="submit"  (click)="AddRxMedicinetoList()"  [ngClass]="{disabledBtn:isReadOnly}"
                                                 fxFlex="7%" cTooltipPlacement="top"
                                                >
                                                <mat-icon class="redIcon" [ngClass]="{disabledIcon:isReadOnly}" >add</mat-icon>
                                            </button>
                                            <button mat-icon-button mat-sm-button color="primary" cTooltip="Refresh"
                                                fxFlex="7%" cTooltipPlacement="top" (click)="RefreshDetail()">
                                                <mat-icon>autorenew</mat-icon>
                                            </button>
                                        </div>
                                    </Row>
                                </c-card>
                            </form>
                            <c-card style="padding: 10px; margin-top: 30px;" class="mat-elevation-z8">
                                <!-- <h5 style="font-size:20px;  color: #04415e;margin: 20px;"> Medicine Detail </h5>-->
                                <c-card-body
                                    style="padding: 10px;background-image: linear-gradient(to bottom, rgb(2, 33, 58), rgb(7, 95, 122));margin: 5px;border-radius: 10px;">
                                    <div class="example-table-container">
                                        <section class="example-container mat-elevation-z8" tabindex="0"
                                            style="border-radius: 5px;">
                                            <table [inert]="viewMode" mat-table [dataSource]="dataSource"
                                                class="mat-elevation-z8">
                                                <ng-container matColumnDef="Id">
                                                    <th mat-header-cell *matHeaderCellDef> Sr No </th>
                                                    <td mat-cell *matCellDef="let element"> {{element.id}} </td>
                                                </ng-container>
                                                <ng-container matColumnDef="medicine">
                                                    <th mat-header-cell *matHeaderCellDef> Medicine</th>
                                                    <td mat-cell *matCellDef="let element"> {{element.medicine}} </td>
                                                </ng-container>
                                                <ng-container matColumnDef="morQty">
                                                    <th mat-header-cell *matHeaderCellDef>Morning Qty </th>
                                                    <td mat-cell *matCellDef="let element"> {{element.amQty}} </td>
                                                </ng-container>
                                                <ng-container matColumnDef="noonQty">
                                                    <th mat-header-cell *matHeaderCellDef>
                                                        <div> Noon Qty</div>
                                                    </th>
                                                    <td mat-cell *matCellDef="let element">
                                                        <div> {{element.noonQty}} </div>
                                                    </td>
                                                </ng-container>
                                                <ng-container matColumnDef="eveQty">
                                                    <th mat-header-cell *matHeaderCellDef> Evening Qty </th>
                                                    <td mat-cell *matCellDef="let element"> {{element.eveQty}} </td>
                                                </ng-container>
                                                <ng-container matColumnDef="days">
                                                    <th mat-header-cell *matHeaderCellDef>Days </th>
                                                    <td mat-cell *matCellDef="let element"> {{element.days}} </td>
                                                </ng-container>
                                                <ng-container matColumnDef="remarks">
                                                    <th mat-header-cell *matHeaderCellDef>Remarks</th>
                                                    <td mat-cell *matCellDef="let element"> {{element.remarks}} </td>
                                                </ng-container>
                                                <ng-container matColumnDef="mr">
                                                    <th mat-header-cell *matHeaderCellDef> Meal Relation </th>
                                                    <td mat-cell *matCellDef="let element"> {{element.mr}} </td>
                                                </ng-container>
                                                <ng-container matColumnDef="actions" stickyEnd style="z-index: 0;">
                                                    <th mat-header-cell *matHeaderCellDef>
                                                        <div style="max-width: 100px; text-align: center;">Actions</div>
                                                    </th>
                                                    <td mat-cell *matCellDef="let row">
                                                        <div [ngClass]="{disabledDiv:isReadOnly}" style="max-width: 100px;text-align: center;">
                                                            <mat-icon class="primaryIcon"
                                                                (click)="edit(row)"
                                                                cTooltip="Edit  Medicine Detail  ">edit</mat-icon>
                                                            <mat-icon class="redIcon" cTooltip="Delete Medicine Detail "
                                                                (click)="delete(row)"> delete</mat-icon>
                                                        </div>
                                                    </td>
                                                </ng-container>
                                                <tr mat-header-row *matHeaderRowDef="displayedColumns sticky: true">
                                                </tr>
                                                <tr mat-row *matRowDef="let row; columns: displayedColumns;">
                                                </tr>
                                            </table>
                                        </section>
                                    </div>
                                </c-card-body>
                            </c-card>
                        </c-card>
                    </mat-tab>
                    <mat-tab label="Reports">
                        <c-card style="margin-top: 40px;padding: 40px;" class="mat-elevation-z8 tab">
                            <form #ReportForm="ngForm" (keydown.enter)="$event.preventDefault()">
                                <c-card *ngIf="!viewMode"
                                    style="padding: 10px;  background:  rgb(209, 238, 243);padding: 20px;"
                                    class="mat-elevation-z8">
                                    <Row>
                                        <div fxLayout="row" fxFlex="100%">
                                            <mat-form-field fxFlex="50%" appearance="outline" class="form-group">
                                                <mat-label> Date</mat-label>
                                                <input matInput
                                                    [min]="utcToLocalDate(selectedReport.date)>minDate?minDate:selectedReport.date"
                                                    [matDatepicker]="picker2" name="date" readonly="true"
                                                    #date="ngModel" [(ngModel)]="selectedReport.date" />
                                                <mat-datepicker-toggle matSuffix
                                                    [for]="picker2"></mat-datepicker-toggle>
                                                <mat-datepicker #picker2></mat-datepicker>
                                            </mat-form-field>
                                            <mat-form-field fxFlex="50%" appearance="outline" class="form-group">
                                                <mat-label>--Please Select Category--</mat-label>
                                                <mat-select name="categoryId" matNativeControl #categoryId="ngModel"
                                                    [(ngModel)]="selectedReport.categoryId">
                                                    <mat-option *ngFor="let pt of categories" [value]=" pt.id">
                                                        {{ pt.name}}
                                                    </mat-option>
                                                </mat-select>
                                                <div matSuffix [ngClass]="{disabledDiv:isReadOnly}">
                                                    <button mat-icon-button style="color:#940540;"
                                                        (click)="OpenCatDialog(); $event.stopPropagation()"
                                                        cTooltip="Explore Category">
                                                        <mat-icon>add</mat-icon>
                                                    </button>
                                                </div>
                                            </mat-form-field>
                                        </div>
                                    </Row>
                                    <Row>
                                        <div fxLayout="row" fxFlex="100%">
                                            <div fxFlex="50%">
                                                <div fxLayout="column">
                                                    <a (click)="fileSelector.click()" class="popup-link" style="padding: 10px; text-decoration: underline;color: rgb(23, 8, 110);
                                                         cursor: pointer;">
                                                        <strong>Browse Report</strong>
                                                    </a>
                                                    <a *ngIf="selectedReport.reportBase64Path"
                                                        (click)="openReportInNewPage(selectedReport.reportBase64Path)"
                                                        class="popup-link"
                                                        style="padding: 10px; color: rgb(78, 104, 135); cursor: pointer;"><strong>
                                                            {{selectedReport.name}} </strong>
                                                    </a>
                                                    <!-- <div class="gallery-img " style=" padding: 10px"
                                                        *ngIf="selectedReport.reportBase64Path">
                                                        <img [src]="selectedReport.reportBase64Path"
                                                            (click)="openReportInNewPage(selectedReport.reportBase64Path)"
                                                            height="120" width="200"
                                                            style="padding:9px;object-fit: cover;">
                                                    </div> -->
                                                    <mat-form-feild>
                                                        <input matinput #fileSelector type="file"
                                                            accept=".png, .jpg, .jpeg, .pdf"
                                                            (change)="handleFileInput($event)" hidden>
                                                    </mat-form-feild>
                                                </div>
                                            </div>
                                            <div fxLayoutAlign="end end" fxFlex="50%" >
                                                <button [ngClass]="{disabledBtn:isReadOnly}" class="bttn" type="submit"
                                                    (click)="Upload();">
                                                    <div *ngIf="rptAddMode">Upload Report</div>
                                                    <div *ngIf="rptEditMode">Update Report</div>
                                                </button>
                                                <button mat-icon-button mat-sm-button color="primary" cTooltip="Refresh"
                                                    fxFlex="7%" cTooltipPlacement="top" (click)="refreshReportLine()">
                                                    <mat-icon>autorenew</mat-icon>
                                                </button>
                                            </div>
                                        </div>
                                    </Row>
                                </c-card>
                            </form>
                            <c-card style="padding: 10px; margin-top: 30px;" class="mat-elevation-z8">
                                <!-- <h5 style="font-size:20px;  color: #04415e;margin: 20px;"> Medicine Detail </h5>-->
                                <c-card-body
                                    style="padding: 10px;background-image: linear-gradient(to bottom, rgb(2, 33, 58), rgb(7, 95, 122));margin: 5px;border-radius: 10px;">
                                    <div class="example-table-container">
                                        <section class="example-container mat-elevation-z8" tabindex="0"
                                            style="border-radius: 5px;">
                                            <table mat-table [dataSource]="rptDataSource"
                                                class="mat-elevation-z8 custom-sort-header " matSort>
                                                <ng-container matColumnDef="Id">
                                                    <th mat-header-cell *matHeaderCellDef> Sr No </th>
                                                    <td mat-cell *matCellDef="let element"> {{element.id}} </td>
                                                </ng-container>
                                                <ng-container matColumnDef="date">
                                                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                                                        class="custom-sort-header"> Date</th>
                                                    <td mat-cell *matCellDef="let element">
                                                        {{element.date|date:"dd/MM/yyyy"}}
                                                    </td>
                                                </ng-container>
                                                <ng-container matColumnDef="category">
                                                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                                                        class="custom-sort-header">Category </th>
                                                    <td mat-cell *matCellDef="let element"> {{element.category}} </td>
                                                </ng-container>
                                                <ng-container matColumnDef="name">
                                                    <th mat-header-cell *matHeaderCellDef>
                                                        <div> Name</div>
                                                    </th>
                                                    <td mat-cell *matCellDef="let element">
                                                        <!-- <a href="javascript:void(0);"
                                                            (click)="openImageInNewPage(element.reportBase64Path)"
                                                            class="popup-link">
                                                            <i class="far fa-eye"></i> View Report
                                                        </a> -->
                                                    </td>
                                                </ng-container>
                                                <ng-container matColumnDef="actions" stickyEnd style="z-index: 0;">
                                                    <th mat-header-cell *matHeaderCellDef
                                                        style="width: 60px; text-align: center;">
                                                        <div>Actions</div>
                                                    </th>
                                                    <td mat-cell *matCellDef="let row"
                                                        style="width: 60px;text-align: center;">
                                                        <div [ngClass]="{disabledDiv:isReadOnly}">
                                                            <a style="justify-content: center;align-items: center;display: block;"
                                                                href="javascript:void(0);" cTooltip="View Report "
                                                                (click)="openReportInNewPage(row.reportBase64Path)"
                                                                class="popup-link">
                                                                <i class="far fa-eye" style="font-size: 20px;"></i>
                                                            </a>
                                                            <a [href]="row.reportBase64Path" download>
                                                                <mat-icon cTooltip="Download Report"
                                                                    class="blueIcon">download</mat-icon>
                                                            </a>
                                                            <!-- <mat-icon href="javascript:void(0);" style=" color:#1e293b
                                                                ;cursor: pointer; "
                                                                (click)=" openImageInNewPage(row.reportBase64Path)"
                                                                cTooltip="View Report">visibility</mat-icon> -->
                                                            <mat-icon [inert]="viewMode" class="primaryIcon"
                                                                style="cursor: pointer; "
                                                                (click)="editRpt(row)"
                                                                cTooltip="Edit Report">edit</mat-icon>
                                                            <mat-icon [inert]="viewMode" class="redIcon"
                                                                cTooltip="Delete Report " style="cursor: pointer;"
                                                                (click)="deleteRpt(row)">
                                                                delete</mat-icon>
                                                        </div>
                                                    </td>
                                                </ng-container>
                                                <tr mat-header-row *matHeaderRowDef="rptDisplayedCol sticky: true">
                                                </tr>
                                                <tr mat-row *matRowDef="let row; columns: rptDisplayedCol;">
                                                </tr>
                                            </table>
                                        </section>
                                    </div>
                                </c-card-body>
                            </c-card>
                        </c-card>
                    </mat-tab>
                    <mat-tab label="Next Visit">
                        <c-card [inert]="viewMode" style="margin-top: 40px;padding: 40px;" class="mat-elevation-z8 tab">
                            <Row>
                                <div fxLayout="row" fxFlex="100%" >
                                    <mat-form-field fxFlex="100%" appearance="outline" class="form-group">
                                        <mat-label> NextVisit Date</mat-label>
                                        <input matInput
                                            [min]="utcToLocalDate(selectedPrescription.nextVisitDate)>=minDate?minDate:selectedPrescription.nextVisitDate"
                                            [matDatepicker]="picker1" name="nextVisitDate" readonly="true"
                                            #nextVisitDate="ngModel" [(ngModel)]="selectedPrescription.nextVisitDate" />
                                        <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
                                        <mat-datepicker #picker1 (closed)="onBlur()"></mat-datepicker>
                                    </mat-form-field>
                                </div>
                            </Row>
                            <Row>
                                <div fxLayout="row" fxFlex="100%">
                                    <mat-form-field fxFlex="100%" appearance="outline" class="form-group">
                                        <mat-label>Comments</mat-label>
                                        <textarea (blur)="onBlur()" name="comments" matNativeControl #comments="ngModel"
                                            [(ngModel)]="selectedPrescription.comments">
                                   </textarea>
                                    </mat-form-field>
                                </div>
                            </Row>
                        </c-card>
                    </mat-tab>
                </mat-tab-group>
            </div>
            <c-card style="margin-top: 40px;padding: 40px;margin-left: 50px;margin-right: 50px;"
                class="mat-elevation-z8 tab">
                <c-card style="padding: 10px;  background:  rgb(209, 238, 243);padding: 20px;" class="mat-elevation-z8">
                    <Row [inert]="viewMode">
                        <div fxLayout="row" fxFlex="100%">
                            <mat-form-field fxFlex="100%" appearance="outline">
                                <mat-label> Select Precautions</mat-label>
                                <mat-select (closed)="onBlur()" name="precauts" multiple matNativeControl
                                    #precauts="ngModel" [(ngModel)]="selectedPrescription.precauts">
                                    <mat-option *ngFor="let pt of precautions" [value]=" pt.id">
                                        {{ pt.name}}
                                    </mat-option>
                                </mat-select>
                                <div matSuffix [ngClass]="{disabledDiv:isReadOnly}">
                                    <button mat-icon-button style="color:#940540;"
                                        (click)="OpenPrecautDialog(); $event.stopPropagation()"
                                        cTooltip="Explore Precautions">
                                        <mat-icon>add</mat-icon>
                                    </button>
                                </div>
                            </mat-form-field>
                        </div>
                    </Row>
                </c-card>
                <c-card style="padding: 10px; margin-top: 30px;" class="mat-elevation-z8"
                    *ngIf="rxPrecaultList.length>0">
                    <div>
                        <h4 style="margin-left: 10px;text-align: center;">Precautions</h4>
                        <ul>
                            <li class="precautList" *ngFor="let item of rxPrecaultList">
                                <div>{{ item }}
                                </div>
                                <!-- <hr> -->
                            </li>
                        </ul>
                    </div>
                </c-card>
            </c-card>
            <div fxLayoutAlign="end end">
                <div style="margin-top: 10px;" *ngIf="!proccessing">
                    <mat-button-toggle-group *ngIf="Add"  [ngClass]="{disIconBtn:isReadOnly}">
                        <mat-button-toggle class="split-button-1 submit-btn"  [ngClass]="{splitbutton1dis:isReadOnly}" (click)="Submit();"> <mat-icon>check_circle</mat-icon> Submit</mat-button-toggle>
                        <mat-button-toggle class="split-button-1 drop-down-button"  [ngClass]="{splitbutton1dis:isReadOnly}" [matMenuTriggerFor]="dropdownMenu">
                          <mat-icon>arrow_drop_down</mat-icon>
                        </mat-button-toggle>
                      </mat-button-toggle-group>
                      <mat-button-toggle-group *ngIf="Edit"  [ngClass]="{disIconBtn:isReadOnly}">
                        <mat-button-toggle class="split-button-1 submit-btn" [ngClass]="{splitbutton1dis:isReadOnly}" (click)="Submit();"> <mat-icon>check_circle</mat-icon> Update</mat-button-toggle>
                        <mat-button-toggle class="split-button-1 drop-down-button" [ngClass]="{splitbutton1dis:isReadOnly}" [matMenuTriggerFor]="dropdownMenuThree">
                          <mat-icon>arrow_drop_down</mat-icon>
                        </mat-button-toggle>
                      </mat-button-toggle-group>
                      <mat-menu #dropdownMenu="matMenu" xPosition="before">
                        <button  type="submit" mat-menu-item  class="menu-item" (click)="isSendMail=true;Submit();">
                            <mat-icon class="menu-item-icon">email</mat-icon>
                            <span class="menu-item-text">Save & Mail</span>
                          </button>
                          <button  type="submit" mat-menu-item  class="menu-item" (click)="isPrint=true;Submit()">
                            <mat-icon class="menu-item-icon">picture_as_pdf</mat-icon>
                            <span class="menu-item-text">Save & Pdf</span>
                          </button>
                      </mat-menu>
                      <mat-menu #dropdownMenuThree="matMenu" xPosition="before">
                        <button  type="submit" mat-menu-item  class="menu-item" (click)="isSendMail=true;Submit();">
                            <mat-icon class="menu-item-icon">email</mat-icon>
                            <span class="menu-item-text">Update & Mail</span>
                          </button>
                          <button  type="submit" mat-menu-item  class="menu-item" (click)="isPrint=true;Submit();">
                            <mat-icon class="menu-item-icon">picture_as_pdf</mat-icon>
                            <span class="menu-item-text">Update & Pdf</span>
                          </button>
                      </mat-menu>
                      <mat-button-toggle-group style="background: none;" *ngIf="!viewMode">
                        <mat-button-toggle style="background-color:#4e4c4c ;color: white;margin: 5px;"  (click)="Back();"> 
                           Go Back</mat-button-toggle>
                      </mat-button-toggle-group>
                    <!-- <button *ngIf="Add" cButton class="me-1" style="background-color:#1e293b ;width: 100px;"
                        type="submit" (click)="Submit();">
                        Submit
                    </button>
                    <button *ngIf="Edit" cButton class="me-1" style="background-color:#1e293b ;width: 100px;"
                        type="submit" (click)="Submit()">
                        Update
                    </button> -->
                    <!-- <button cButton class="me-1" style="background-color:#7b7c7e ;width: 100px;" (click)="Back()">
                        Go Back
                    </button> -->
                </div>
                <div>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="gallery-lightbox-container">
    <div *ngIf="previewImage" class="lightbox">
        <button mat-icon-button *ngIf="previewImage" (click)="onClosePreview()" class="close-button"
            style="color:white;margin-right:15px">
            <mat-icon>close</mat-icon>
        </button>
        <div *ngIf="previewImage" class="lightbox-img" style="display: flex; overflow: auto;">
            <img [src]="currentLightBoxImage" style=" height:400px;">
        </div>
    </div>
</div>
<div>
    <div *ngIf="isLoading" class="spinnerBox">
        <c-spinner style="height: 100px;width: 100px;color: white;"></c-spinner>
    </div>
</div>
